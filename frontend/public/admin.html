<!DOCTYPE html>
<html lang="fr">

<head>
  <meta charset="UTF-8" />
  <title>Admin - Gestion</title>
  <script>
    async function chargerUtilisateurs() {
      const reponse = await fetch('http://localhost:3000/api/users');
      const utilisateurs = await reponse.json();
      const tbody = document.getElementById('utilisateurs');

      tbody.innerHTML = '';
      utilisateurs.forEach(user => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td><input type="text" value="${user.firstName}" id="firstName-${user._id}"></td>
          <td><input type="text" value="${user.lastName}" id="lastName-${user._id}"></td>
          <td><input type="text" value="${user.email}" id="email-${user._id}"></td>
          <td><input type="text" value="" placeholder="mot de passe" id="motdepasse-${user._id}"></td>
          <td>
            <button onclick="modifierUtilisateur('${user._id}')">Modifier</button>
            <button onclick="remplacerUtilisateur('${user._id}')">Remplacer</button>
            <button onclick="supprimerUtilisateur('${user._id}')">Supprimer</button>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    async function modifierUtilisateur(id) {
      const data = {
        firstName: document.getElementById(`firstName-${id}`).value,
        lastName: document.getElementById(`lastName-${id}`).value,
        email: document.getElementById(`email-${id}`).value
      };
      const motdepasse = document.getElementById(`motdepasse-${id}`).value;
      if (motdepasse) {
        data.motdepasse = motdepasse;
      }

      const reponse = await fetch(`http://localhost:3000/api/users/${id}`, {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      });

      if (reponse.ok) {
        alert('Utilisateur modifié (PATCH)');
        chargerUtilisateurs();
      } else {
        const erreur = await reponse.json();
        alert('Erreur : ' + (erreur.message || 'inconnue'));
      }
    }

    async function remplacerUtilisateur(id) {
      const data = {
        firstName: document.getElementById(`firstName-${id}`).value,
        lastName: document.getElementById(`lastName-${id}`).value,
        email: document.getElementById(`email-${id}`).value,
        motdepasse: document.getElementById(`motdepasse-${id}`).value
      };

      const reponse = await fetch(`http://localhost:3000/api/users/${id}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      });

      if (reponse.ok) {
        alert('Utilisateur remplacé (PUT)');
        chargerUtilisateurs();
      } else {
        const erreur = await reponse.json();
        alert('Erreur : ' + (erreur.message || 'inconnue'));
      }
    }

    async function supprimerUtilisateur(id) {
      const confirmation = confirm("Supprimer cet utilisateur ?");
      if (!confirmation) return;

      const reponse = await fetch(`http://localhost:3000/api/users/${id}`, {
        method: 'DELETE'
      });

      if (reponse.ok) {
        alert('Utilisateur supprimé');
        chargerUtilisateurs();
      } else {
        const erreur = await reponse.json();
        alert('Erreur : ' + (erreur.message || 'inconnue'));
      }
    }

    async function chargerCapteurs() {
      try {
        const reponse = await fetch('http://localhost:3000/api/sensors');
        const capteurs = await reponse.json();

        const capteursRecents = capteurs
          .sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt))
          .slice(0, 10);

        const tbody = document.getElementById('capteurs');
        tbody.innerHTML = '';

        capteursRecents.forEach(sensor => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${sensor._id}</td>
            <td><input type="text" value="${sensor.name}" id="name-${sensor._id}" /></td>
            <td><input type="text" value="${sensor.type}" id="type-${sensor._id}" /></td>
            <td><input type="text" value="${sensor.unit}" id="unit-${sensor._id}" /></td>
            <td>${sensor.userId?.firstName || 'N/A'} ${sensor.userId?.lastName || ''}</td>
            <td>
              <input type="hidden" value="${sensor.userId?._id || sensor.userId}" id="userId-${sensor._id}">
              <button onclick="remplacerCapteur('${sensor._id}')">Remplacer</button>
            </td>
          `;
          tbody.appendChild(tr);
        });

      } catch (error) {
        console.error('Erreur lors du chargement des capteurs :', error);
      }
    }

    async function remplacerCapteur(id) {
      const data = {
        name: document.getElementById(`name-${id}`).value,
        type: document.getElementById(`type-${id}`).value,
        unit: document.getElementById(`unit-${id}`).value,
        userId: document.getElementById(`userId-${id}`).value
      };

      const reponse = await fetch(`http://localhost:3000/api/sensors/${id}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      });

      if (reponse.ok) {
        alert('Capteur remplacé (PUT)');
        chargerCapteurs();
      } else {
        const erreur = await reponse.json();
        alert('Erreur : ' + (erreur.message || 'inconnue'));
      }
    }

    async function rechercherCapteurParId() {
      const id = document.getElementById('rechercheCapteurId').value.trim();
      if (!id) return;

      try {
        const reponse = await fetch(`http://localhost:3000/api/sensors`);
        const capteurs = await reponse.json();
        const capteur = capteurs.find(c => c._id === id);

        const resultDiv = document.getElementById('resultatRecherche');
        resultDiv.innerHTML = '';

        if (capteur) {
          resultDiv.innerHTML = `
            <p><strong>Résultat :</strong></p>
            <table border="1" cellpadding="8">
              <tr>
                <th>ID</th>
                <th>Nom</th>
                <th>Type</th>
                <th>Unité</th>
                <th>Utilisateur</th>
              </tr>
              <tr>
                <td>${capteur._id}</td>
                <td>${capteur.name}</td>
                <td>${capteur.type}</td>
                <td>${capteur.unit}</td>
                <td>${capteur.userId?.firstName || 'N/A'} ${capteur.userId?.lastName || ''}</td>
              </tr>
            </table>
          `;
        } else {
          resultDiv.innerHTML = `<p style="color:red">Aucun capteur trouvé avec cet ID.</p>`;
        }
      } catch (error) {
        console.error('Erreur lors de la recherche :', error);
      }
    }

    async function chargerMesures() {
      const reponse = await fetch('http://localhost:3000/api/measurements');
      toutesLesMesures = await reponse.json();
      afficherMesures(toutesLesMesures);
    }


    function afficherMesures(mesures) {
      const tbody = document.getElementById('mesures');
      tbody.innerHTML = '';

      mesures.forEach(m => {
        const date = new Date(m.takenAt).toLocaleDateString();
        const capteurNom = m.sensorId?.name || 'N/A';
        const capteurType = m.sensorId?.type || 'undefined';

        tbody.innerHTML += `
      <tr>
        <td><input type="number" value="${m.value}" id="valeur-${m._id}" /></td>
        <td>${capteurNom} (${capteurType})</td>
        <td>${date}</td>
        <td>
          <button onclick="modifierMesure('${m._id}')">Modifier</button>
        </td>
      </tr>
    `;
      });
    }

    async function modifierMesure(id) {
      const value = document.getElementById(`valeur-${id}`).value;
      const reponse = await fetch(`http://localhost:3000/api/measurements/${id}`, {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ value })
      });

      if (reponse.ok) {
        alert('Mesure modifiée (PATCH)');
        chargerMesures();
      } else {
        alert('Erreur : ' + (erreur.message || 'inconnue'));
      }

    }
    let toutesLesMesures = [];

    window.onload = function () {
      chargerUtilisateurs();
      chargerCapteurs();
      chargerMesures();

      document.getElementById("filtreCapteur").addEventListener("input", function () {
        const filtre = this.value.trim().toLowerCase();

        const filtrées = toutesLesMesures.filter(m =>
          m.sensorId &&
          (m.sensorId._id?.toLowerCase().includes(filtre) ||
            m.sensorId.name?.toLowerCase().includes(filtre))
        );

        afficherMesures(filtrées);
      });
    };
  </script>
</head>

<body>
  <h1>Admin - Gestion</h1>

  <h2>Gestion des utilisateurs</h2>
  <table border="1" cellpadding="8">
    <thead>
      <tr>
        <th>Prénom</th>
        <th>Nom</th>
        <th>Email</th>
        <th>Mot de passe</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody id="utilisateurs"></tbody>
  </table>

  <h2>Rechercher un capteur par ID</h2>
  <input type="text" id="rechercheCapteurId" placeholder="ID du capteur">
  <button onclick="rechercherCapteurParId()">Rechercher</button>
  <div id="resultatRecherche"></div>

  <h2>Liste des 10 derniers capteurs</h2>
  <table border="1" cellpadding="8">
    <thead>
      <tr>
        <th>ID</th>
        <th>Nom</th>
        <th>Type</th>
        <th>Unité</th>
        <th>Utilisateur</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody id="capteurs"></tbody>
  </table>
  <h2>Liste complète des mesures</h2>
  <input type="text" id="filtreCapteur" placeholder="Filtrer par ID capteur">
  <table border="1" cellpadding="8">
    <thead>
      <tr>
        <th>Valeur</th>
        <th>Capteur</th>
        <th>Date</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody id="mesures"></tbody>
  </table>

</body>

</html>